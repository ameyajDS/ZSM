@using DCC.UMB.WDF.DB;
@using System.Configuration;
@using DCC.UMB.WDF.Models;

@using System.Data;
@using SysAdminModel;
@using System.Collections.Generic;
@using DCC.UMB.WDF.Utils;
@using System.Web.Optimization;

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>C D B</title>

    @*[[The below two lines will include the site css and common js requried for this project*@
    @Html.Raw(DCC.UMB.WDF.Utils.UtilityManager.GetSiteCSSScriptLet())
    @Html.Raw(DCC.UMB.WDF.Utils.UtilityManager.GetCmnJSScriptLet())
    @*@Html.Raw(DCC.UMB.WDF.Utils.UtilityManager.GetXCSJSScriptLet())*@
    @{
        //[[Check if this request opens this app in colorBoxed IFrame in new/update/reference mode.
        string strUiMode = "" + HttpContext.Current.Request["uiMode"];
        //string strScreenId = "" + HttpContext.Current.Request["screen_id"];
        UIModes? uiMode = 0;
        if (!string.IsNullOrEmpty(strUiMode)) {
            strUiMode = strUiMode.ToLower().Trim().Replace("/", "");
            uiMode = (UIModes)(Convert.ToInt32(strUiMode));
        }
        bool isColorBoxed = uiMode == UIModes.New || uiMode == UIModes.Update || uiMode == UIModes.Reference;
        //]]

        List<User_role_menu_group> lstMenuGroups = AppContextManager.Instance.GetMenuGroupsForUser();
        System.Text.StringBuilder menuShortKeyBindingJSStringBuilder = new System.Text.StringBuilder();
        string appAsJson = Newtonsoft.Json.JsonConvert.SerializeObject(AppContextManager.Instance.GetApplication(), Newtonsoft.Json.Formatting.Indented);
    }
    @*]]*@

    @Scripts.Render("~/c/js/cdbJS")




    @RenderSection("ScreenSpecificResources", false)

    <link rel="stylesheet" type="text/css" href="/auth/c/css/ng-grid.css" />
    <link rel="stylesheet" type="text/css" href="/sci/css/sci.css" />

</head>
<body>
    <div style="" class="unselectable wdf-grad-{{coreManager.getCurrentGradientName()}}" ng-app="@AppContextManager.Instance.PackageId"
         ng-controller="wdf_core_ctrl"
         id="wdf_root_div_id"
         user_id="@Membership.GetUser().UserName" ng-init="init(@((int)uiMode),@appAsJson)">
        <!--[[This is the lookup div which is shown as modal dialog -->
        <section>
            <div id="wdf_lookup_div_id" class="modal modal-override hide" tabindex="-1" role="dialog">
                <div class="modal-header modal-header-override">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 id="myModalLabel">{{lookupManager.lookupTitle}}</h4>
                    <div class="row-fluid">
                        <div ng-show="lookupManager.messageText" class="alert  alert-error">
                            <strong>ALERT !</strong> {{lookupManager.messageText}}
                        </div>
                    </div>
                    <div class="row-fluid">
                        <div class="span10 input-append">
                            <input class="span12   ng-pristine ng-valid" id="txtLookupDialogFilter" name="txtLookupDialogFilter" type="text" offset="0" maxlength="60" placeholder="Filter here.."
                                   ng-model="lookupManager.lookupQueryCriteria.searchString" ui-keypress="{13:'lookupManager.ReloadLookupResult()',9:'lookupManager.FocusOnTable()'}" />
                            <button tabindex="-1" type="button" class="btn" ng-click="lookupManager.ReloadLookupResult()">
                                <i class="icon-search"></i>
                            </button>
                        </div>
                        <div id="wdf_lookup_command_buttons" class="row-fluid offset1 span5 pull-right">
                            <button id="btnReference" class="btn pull-right" ng-show="lookupManager.shouldShowToolBarButton('reference')" ng-click="lookupManager.fireReference()" title="View this record completely">
                                <i class="icon-expand"></i>
                            </button>
                            <button id="btnUpdate" class="btn pull-right" ng-show="lookupManager.shouldShowToolBarButton('update')" ng-click="lookupManager.fireUpdate()" title="Update this record in its screen">
                                <i class="icon-pencil"></i>
                            </button>
                            <button id="btnNew" class="btn pull-right" ng-show="lookupManager.shouldShowToolBarButton('new')" ng-click="lookupManager.fireNew()" title="Add a new record">
                                <i class="icon-plus"></i>
                            </button>
                        </div>
                    </div>

                </div>
                <div class="modal-body modal-body-override">
                    <div ng-hide="lookupManager.lookupResultSet" style="text-align: center">
                        <img src="/Auth/c/img/wait.gif" />
                    </div>
                    <table tabindex="1" id="tblLookupDialog" class="table table-striped table-bordered table-hover table-condensed">
                        <thead>
                            <tr>
                                <th style="text-align: center; width: 40px">Select</th>
                                <th style="text-align: center; width: {{col.PercentageWidth}}%; display: {{col.PercentageWidth<=0 && 'none' || 'table-cell'}}" ng-repeat="col in lookupManager.lookupResultSet.LstColumnInfos">{{col.Name}}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr tabindex="1" ng-repeat="res in lookupManager.lookupResultSet.LstQueryRecords" ng-click="lookupManager.setSelectedRecord(res)"
                                ng-dblclick="lookupManager.CaptureLookupResultInField($event,res)" ui-keypress="{13:'lookupManager.CaptureLookupResultInField($event,res)'}">
                                <td style="text-align: center;" ng-click="lookupManager.CaptureLookupResultInField($event,res)"><a style="padding-left: 4px; width: 100%; height: 100%" href="" title="Select"><i class="icon-flag"></i></a></td>
                                <td style="display: {{col.PercentageWidth<=0 && 'none' || 'table-cell'}}" ng-repeat="col in lookupManager.lookupResultSet.LstColumnInfos">{{lookupManager.GetLookupCellValue(res,col)}}</td>
                            </tr>
                        </tbody>
                    </table>
                    <br />
                </div>
                <div class="modal-footer modal-footer-override">
                    <span>* Double click on a record to select ...</span>
                </div>
            </div>
        </section>
        <!--]] -->
        <!--[[This section has the templates for different wdf directives-->
        <section>
            <script type="text/ng-template" id="partials/listGrid.html">
                <div class="row-fluid">
                    <div class="row-fluid">
                        <h5 class="span4 ">{{targetModel.LstQueryRecords.length>0 && 'Search Results'|| 'Nothing found :-('}}</h5>
                    </div>
                    <div class="row-fluid">
                        <div class="span12">
                            <table class="table table-striped table-bordered table-hover table-condensed">
                                <thead>
                                    <tr>
                                        <th style="text-align:center; width: 2%">Edit</th>
                                        <th style="text-align:center; width: {{col.PercentageWidth}}%; display:{{col.PercentageWidth<=0 && 'none' || 'table-cell'}}" ng-click="SetSortOnColumn(col)" ng-repeat="col in targetModel.LstColumnInfos">{{col.Name}} <i class="pull-right {{GetSortIconClass(col)}}"></i></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="res in targetModel.LstQueryRecords" ng-dblclick="RowClicked(res)">
                                        <td style="text-align:center;"> <a style=" padding-left: 4px " href="" ng-click="RowClicked(res)" title="Edit"><i class="icon-pencil"></i></a></td>
                                        <td style="text-align:{{GetTextAlignment(col)}}; display:{{col.PercentageWidth<=0 && 'none' || 'table-cell'}}" ng-repeat="col in targetModel.LstColumnInfos">
                                            <ng-switch on="ShouldShowLink(col)">
                                                <span ng-switch-when="false">{{col.PercentageWidth>0 && GetLookupCellValue(res,col)||''}}</span>
                                                <span style="color:blue" ng-switch-when="true" ng-click="OpenLinkedScreen($event,res,col)">{{GetLookupCellValue(res,col)}}</span>
                                            </ng-switch>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </script>

        </section>
        <!--]]-->
        <!-- [[Top Nav bar i.e. Menu groups and menus therein-->
        <div ng-hide="@isColorBoxed.ToString().ToLower()" class="navbar navbar-fixed-top">
            <div class="navbar-inner navbar-inner-@AppContextManager.Instance.GetApplication().style_nm">
                <div class="pull-left">
                    <img src="/Auth/c/img/RSSB.jpg" class="rssb-logo" style="display: inline" />
                    <span class="Three-Dee">@AppContextManager.Instance.GetCurrentApplicationName()</span>
                    @*<img src="/Auth/c/img/wait.gif" ng-show="httpBusy" />*@
                    <span id="ScreenNameNMode" class="screenName">{{coreManager.getCurrentScreenName()}} {{coreManager.currentUIMode && " : " + coreManager.getCurrentUIModeName() || ''}}</span>
                    <span id="ScreenID" class="screenName ">{{coreManager.getCurrentScreenManager().getScreenId()}}</span>
                    <br />
                    <ul class="nav">
                        @foreach (User_role_menu_group grp in lstMenuGroups) {
                            if (AppContextManager.Instance.GetMenusForUser((int)grp.user_role_menu_group_id.Value).Count <= 0) {//i.e. if there is no menu under this menu group, then dont even render the main menu group.
                                continue;
                            }
                            menuShortKeyBindingJSStringBuilder.Append(string.Format("wdf.utils.addShortcutKeyToMenuGroup('{0}');", grp.display_order));
                            if (grp.user_role_parent_menu_group_id_lookup != null && !string.IsNullOrEmpty(grp.user_role_parent_menu_group_id_lookup.Id)) { continue; }
                            <li class="dropdown">
                                <a id="@("mnugrp_" + grp.display_order)" style="cursor:pointer" class="dropdown-toggle" data-toggle="dropdown">
                                    @grp.menu_group_dsc<span class="wdf-menu-shrtcut-hint"> @("" + grp.display_order)</span>
                                </a>

                                <ul class="dropdown-menu dropdown-menu-override">
                                    @foreach (User_role_menu menu in AppContextManager.Instance.GetMenusForUser((int)grp.user_role_menu_group_id.Value)) {
                                        <li>
                                            @*<span style="cursor:pointer" onClick="@("window.location.href='/" + AppContextManager.Instance.PackageId + "#/" + menu.menu_nm.Replace(" ", "") + "';")">*@
                                            <span style="cursor:pointer" ng-click="@(string.Format("coreManager.FireMenuClicked('{0}','{1}');", AppContextManager.Instance.PackageId, menu.menu_nm.Replace(" ", "")))">
                                                <span>@Html.Raw(menu.DescriptionWithMnemonics)</span>
                                                @if (!string.IsNullOrEmpty(menu.ctrl_key_accessor)) {
                                                    <span class="menu-shortcut">@Html.Raw(string.Format("Alt + {0} {1}", grp.display_order, menu.ctrl_key_accessor.ToUpper()))</span>
                                                }
                                            </span>
                                        </li>
                                                if (!string.IsNullOrEmpty(menu.ctrl_key_accessor)) {
                                                    menuShortKeyBindingJSStringBuilder.Append(string.Format("wdf.utils.addShortcutKeyToMenu('{0}','{1}','/{2}/#/{3}');", grp.display_order, menu.ctrl_key_accessor, AppContextManager.Instance.PackageId, menu.menu_nm.Replace(" ", "")));
                                                }
                                    }
                                </ul>
                            </li>
                        }
                    </ul>
                    <div style="clear: left">
                        <div class="btn-group ">
                            <button id="btnInsert" class="btn" ng-hide="coreManager.shouldHideToolBarButton('New')" ng-disabled="coreManager.shouldDisableToolBarButton('New')" ng-click="coreManager.fireInsert()" title="Switch to Insert mode (Ctrl+I)"><i class="icon-plus"></i></button>
                            <button id="btnSave" class="btn" ng-hide="coreManager.shouldHideToolBarButton('Save')" ng-disabled="coreManager.shouldDisableToolBarButton('Save')" ng-click="coreManager.fireSave()" title="Save (Ctrl+S)"><i class="icon-disk"></i></button>
                            <button id="btnClear" class="btn" ng-hide="coreManager.shouldHideToolBarButton('Clear')" ng-disabled="coreManager.shouldDisableToolBarButton('Clear')" ng-click="coreManager.fireClear()" title="Clear (Ctrl+F2)"><i class="icon-loop2"></i></button>
                        </div>
                        <div class="btn-group">
                            <button id="btnQuery" class="btn" ng-hide="coreManager.shouldHideToolBarButton('Query')" ng-disabled="coreManager.shouldDisableToolBarButton('Query')" ng-click="coreManager.fireQuery()" title="Switch to Query mode (Ctrl+Q)"><i class="icon-search"></i></button>
                            <button id="btnGet" class="btn" ng-hide="coreManager.shouldHideToolBarButton('Get')" ng-disabled="coreManager.shouldDisableToolBarButton('Get')" ng-click="coreManager.fireGet()" title="Retrieve records for your query (Ctrl+G)"><i class="icon-download"></i></button>
                        </div>
                        <div class="btn-group ">
                            <button id="btnDelete" class="btn" ng-hide="coreManager.shouldHideToolBarButton('Delete')" ng-disabled="coreManager.shouldDisableToolBarButton('Delete')" ng-click="coreManager.fireDelete()" title="Delete (Ctrl+Del)"><i class="icon-remove"></i></button>
                            <button id="btnListDetail" class="btn" ng-hide="coreManager.shouldHideToolBarButton('List/Detail')" ng-disabled="coreManager.shouldDisableToolBarButton('List/Detail')" ng-click="coreManager.toggleListDetailView()" title="List/Detail (Ctrl + D)"><i class="{{coreManager.isListView() && 'icon-pencil' || 'icon-list'}}"></i></button>
                            <button id="btnFirst" class="btn" ng-hide="coreManager.shouldHideToolBarButton('First')" ng-disabled="coreManager.shouldDisableToolBarButton('First')" ng-click="coreManager.fireFirst()" title="First (Ctrl + Shift + ←)"><i class="icon-first"></i></button>
                            <button id="btnPrevious" class="btn" ng-hide="coreManager.shouldHideToolBarButton('Previous')" ng-disabled="coreManager.shouldDisableToolBarButton('Previous')" ng-click="coreManager.firePrevious()" title="Previous (Ctrl + ←)"><i class="icon-arrow-left"></i></button>
                            <button id="btnNext" class="btn" ng-hide="coreManager.shouldHideToolBarButton('Next')" ng-disabled="coreManager.shouldDisableToolBarButton('Next')" ng-click="coreManager.fireNext()" title="Next (Ctrl + →)"><i class="icon-arrow-right"></i></button>
                            <button id="btnLast" class="btn" ng-hide="coreManager.shouldHideToolBarButton('Last')" ng-disabled="coreManager.shouldDisableToolBarButton('Last')" ng-click="coreManager.fireLast()" title="Last (Ctrl + Shift + →)"><i class="icon-last"></i></button>
                        </div>
                        <div class="btn-group ">
                            <button id="btnReport" class="btn" ng-hide="coreManager.shouldHideToolBarButton('Report')" ng-disabled="coreManager.shouldDisableToolBarButton('Report')" ng-click="coreManager.fireReport()" title="Report (Ctrl+R)"><i class="icon-newspaper"></i></button>
                            <button id="btnPrint" class="btn" ng-hide="coreManager.shouldHideToolBarButton('Print')" ng-disabled="coreManager.shouldDisableToolBarButton('Print')" ng-click="coreManager.firePrint()" title="Print (Ctrl+P)"><i class="icon-print"></i></button>
                            <button id="btnCog" style="visibility:@(UtilityManager.IsDevEnv ? "visible" : "hidden") class=" btn" ng-click="coreManager.toggleDebugView()"><i class="icon-cog"></i></button>
                        </div>
                        @* <div class="btn-group ">
                            <button class="btn" ng-disabled="coreManager.shouldHideToolBarButton('Close')" ng-click="coreManager.fireClose('@AppContextManager.Instance.PackageId')" title="Close (Ctrl+F2)"><i class="icon-minus"></i></button>
                            <button class="btn" ng-click="coreManager.fireDashboard()" title="Dashboard"><i class="icon-home3"></i></button>
                             </div>*@

                        <div class="btn-group" ng-show="coreManager.getCurrentScreenActions()">
                            <a class="btn dropdown-toggle btn-inverse" data-toggle="dropdown" href="">
                                Actions
                                <span class="caret"></span>
                            </a>
                            <ul class="dropdown-menu">
                                @*<li><a>Lock</a></li>
                                    <li><a>UnLock</a></li>*@
                                <li ng-repeat="action in coreManager.getCurrentScreenActions()">
                                    <a ng-click="coreManager.executeScreenAction(action)">{{action}}</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <!--[[We will show wait graphics in this bar-->
                    <div id="waitbar" ng-show="httpBusy">
                        <span class="expand-wait-bar"></span>
                    </div>
                    <!--]]-->
                </div>

                <div style="margin-top: 10px" class="pull-right">
                    <div style="text-align: right">
                        <div class="userInfo">
                            @(((DCC.UMB.WDF.Providers.DCCMembershipUser)Membership.GetUser()).FullName)[@(((DCC.UMB.WDF.Providers.DCCMembershipUser)Membership.GetUser()).GetCurrentRole(AppContextManager.Instance.PackageId))]
                        </div>
                        <div class="lastLogonDate">
                            <a href="/auth/user/Dashboard?stay=true">Dashboard</a> | <a href="/auth/user/logout">Logout</a>
                            <br />
                            Last login: @(DateTime.Now.ToString("dd MMM yy"))
                        </div>
                        <div style="font-size: xx-small; line-height: 12px;">
                            @*Build Dt: @((new System.IO.FileInfo(System.Reflection.Assembly.GetExecutingAssembly().Location)).CreationTime.ToString("dd MMM yy"))*@
                            @UtilityManager.GetBuildInfo()
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <!-- ]]-->
        <div style="margin-top: @(isColorBoxed ? "0px" : "90px")">
        </div>

        <!-- [[ This div is shown when the screen is shown in colorbox, and represents the toolbar of the colorboxed screen-->
        <div style="padding-top:10px" ng-show="@isColorBoxed.ToString().ToLower()">
            <div class="btn-group pull-left">
                <button id="btnSaveAndClose" class="btn" ng-hide="coreManager.shouldHideToolBarButton('SaveAndClose')" ng-disabled="coreManager.shouldDisableToolBarButton('SaveAndClose')" ng-click="coreManager.fireSaveAndClose()" title="Save & Close (Ctrl+S)"><i class="icon-disk"></i></button>
                <button id="btnClearModal" class="btn" ng-hide="coreManager.shouldHideToolBarButton('Clear')" ng-disabled="coreManager.shouldDisableToolBarButton('Clear')" ng-click="coreManager.fireClear()" title="Clear (Ctrl+F2)"><i class="icon-loop2"></i></button>
                <button id="btnCloseModal" class="btn" ng-click="coreManager.fireCloseColorBox()" title="Exit(Ctrl+Esc)"><i class="icon-exit"></i></button>
            </div>
            <div>
                <span class="screenNameModal">{{coreManager.getCurrentScreenName()}} {{coreManager.currentUIMode && " : " + coreManager.getCurrentUIModeName() || ''}}</span>
            </div>
            <!--[[We will show wait graphics in this bar-->
            <div id="waitbar" style="height: 5px">
                <span ng-show="httpBusy" class="expand-wait-bar"></span>
            </div>
            <!--]]-->
        </div>

        <!--]]-->
        <div ng-show="coreManager.MessageText" class="alert  alert-{{coreManager.MessageType.toLowerCase()}} alert-override">
            <button type="button" class="close" ng-click="coreManager.ClearMessageBar()">&times;</button>
            <strong>{{coreManager.MessageType}}!</strong> {{coreManager.MessageText}}

        </div>
        <div style="margin-bottom: 10px" class=""></div>
        <div class="row-fluid">
            <div class="tabbable {{coreManager.showDebugPane && 'span8' || 'span12'}}">
                <!-- Only required for left/right tabs -->
                <div class="tab-content row-fluid" style="overflow:visible">
                    <div style="padding-bottom: 30px;" id="wdf-detailed-view" class="wdf-screen-pane tab-pane {{!coreManager.isListView() && 'active' || ''}}">
                        <fieldset id="wdfScreenFieldSet" ng-disabled="coreManager.isScreenDisabled()">
                            <div ng-view></div>
                        </fieldset>
                    </div>
                    <div style="height: 800px; /*overflow: scroll; */ margin-top: 30px" id="wdf-list-view row-fluid" class="tab-pane {{coreManager.isListView() && 'active' || ''}}">

                        @*<div class="row-fluid span12" style="height: 800px; /*overflow: scroll;*/ margin-top: 30px">

                            </div>*@
                        @*Filter: <input type="text" ng-model="quickFilterForAppId" />{{quickFilterForAppId}}*@
                        <button style="margin-right: 10px" id="btnExportToExcel" type="button" class="btn pull-right" ng-click="coreManager.exportToExcel()">
                            Export to Excel  <i class="icon-file-excel"></i>
                        </button>
                        <wdf-list-grid edit-url="coreManager.redirectToBrowseMode(rowObj)"
                                       span-class="span12"
                                       target-model="coreManager.LstSearchResults"></wdf-list-grid>

                    </div>
                </div>


            </div>
            <div class="{{coreManager.showDebugPane && 'span4' || ''}}" ng-show="coreManager.showDebugPane" id="divDebugInfo">
                [---- Debug Info(click toolbar gear button to show/hide----]
                <pre><code class="json">{{coreManager.getDebugJson()}}</code></pre>
            </div>

        </div>

    </div>

    @RenderBody()

    <script type="text/javascript">
        $(function () {
            @Html.Raw(@menuShortKeyBindingJSStringBuilder.ToString());
        });
    </script>
</body>

</html>
